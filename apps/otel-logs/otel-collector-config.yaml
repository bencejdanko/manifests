apiVersion: v1
kind: ConfigMap
metadata:
  name: otel-collector-config
  namespace: monitoring
data:
  collector.yaml: |
    receivers:
      # Receive logs directly from Traefik (OTLP over HTTP)
      otlp:
        protocols:
          http:  # listens on :4318 by default

    processors:
      # Parse Traefik's JSON body (if the body is a JSON string) and copy key fields to attributes
      transform/traefik:
        error_mode: ignore
        log_statements:
          - context: log
            statements:
              # If body is a JSON string, parse it into a map
              - set(body, ParseJSON(body)) where IsString(body)

              # Map key fields to attributes (labels in Loki)
              - set(attributes["http.method"], body.RequestMethod) where IsMap(body)
              - set(attributes["http.target"], body.RequestPath) where IsMap(body)
              - set(attributes["http.status_code"], ToInt(body.DownstreamStatus)) where IsMap(body)
              - set(attributes["net.host.name"], body.RequestHost) where IsMap(body)
              - set(attributes["traefik.entrypoint"], body.entryPointName) where IsMap(body)
              - set(attributes["traefik.router"], body.RouterName) where IsMap(body)
              - set(attributes["traefik.service"], body.ServiceName) where IsMap(body)
              - set(attributes["duration.ns"], ToInt(body.Duration)) where IsMap(body)

      batch:
        send_batch_size: 4096
        timeout: 5s

    exporters:
      # Push to your in-cluster Loki
      loki:
        endpoint: http://loki.monitoring.svc.cluster.local:3100/loki/api/v1/push
        # Which attributes become Loki labels (keep cardinality sane)
        labels:
          attributes:
            - http.method
            - http.status_code
            - traefik.entrypoint
            - traefik.router
            - traefik.service
            - k8s.namespace.name
            - k8s.pod.name
        # Keep resource attributes too (K8s auto-detected by Traefik)
        # default_labels_enabled can be toggled if you want fewer labels:
        # default_labels_enabled: false

    service:
      pipelines:
        logs:
          receivers: [otlp]
          processors: [transform/traefik, batch]
          exporters: [loki]
