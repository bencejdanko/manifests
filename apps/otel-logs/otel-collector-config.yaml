apiVersion: v1
kind: ConfigMap
metadata:
  name: otel-collector-config
  namespace: monitoring
data:
  collector.yaml: |
    receivers:
      otlp:
        protocols:
          http: {}

    processors:
      # This is the correct way
      transform/traefik:
        error_mode: ignore
        log_statements:
          - context: log
            statements:
              # On a modern image, 'matches' exists and works.
              # This parses the body ONLY if it's a string AND looks like a JSON object.
              - set(body, ParseJSON(body)) where IsString(body) and body matches "^{.*}$"

              # These statements will now only run if the body was 
              # successfully parsed into a map.
              - set(attributes["http.method"], body["RequestMethod"]) where IsMap(body)
              - set(attributes["http.target"], body["RequestPath"]) where IsMap(body)
              - set(attributes["http.status_code"], Int(body["DownstreamStatus"])) where IsMap(body)
              - set(attributes["net.host.name"], body["RequestHost"]) where IsMap(body)
              - set(attributes["traefik.entrypoint"], body["entryPointName"]) where IsMap(body)
              - set(attributes["traefik.router"], body["RouterName"]) where IsMap(body)
              - set(attributes["traefik.service"], body["ServiceName"]) where IsMap(body)
              - set(attributes["duration.ns"], Int(body["Duration"])) where IsMap(body)

      batch:
        send_batch_size: 4096
        timeout: 5s

    exporters:
      otlphttp:
        endpoint: http://loki.monitoring.svc.cluster.local:3100/otlp
        headers:
          # This fixes your 401 Unauthenticated error
          X-Scope-OrgID: fake-org

      # Use 'debug' for modern collectors
      debug:
        verbosity: detailed

    service:
      pipelines:
        logs:
          receivers: [otlp]
          # This is the correct, simple pipeline
          processors: [transform/traefik, batch]
          exporters: [otlphttp, debug]