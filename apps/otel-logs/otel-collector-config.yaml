apiVersion: v1
kind: ConfigMap
metadata:
  name: otel-collector-config
  namespace: monitoring
data:
  collector.yaml: |
    receivers:
      otlp:
        protocols:
          http: {}

    processors:
      transform/traefik:
        error_mode: ignore
        log_statements:
          - context: log
            statements:
              # This pattern is from the official documentation.
              # 1. Parse the log body as JSON *into* the cache,
              #    but only if it's a string and matches a JSON pattern.
              - merge_maps(cache, ParseJSON(body), "upsert") where IsString(body) and IsMatch(body, "^{.*}$")

              # 2. Set attributes from the cache. This only runs
              #    if the cache (and the specific key) exists.
              - set(attributes["http.method"], cache["RequestMethod"]) where cache["RequestMethod"] != nil
              - set(attributes["http.target"], cache["RequestPath"]) where cache["RequestPath"] != nil
              - set(attributes["http.status_code"], Int(cache["DownstreamStatus"])) where cache["DownstreamStatus"] != nil
              - set(attributes["net.host.name"], cache["RequestHost"]) where cache["RequestHost"] != nil
              - set(attributes["traefik.entrypoint"], cache["entryPointName"]) where cache["entryPointName"] != nil
              - set(attributes["traefik.router"], cache["RouterName"]) where cache["RouterName"] != nil
              - set(attributes["traefik.service"], cache["ServiceName"]) where cache["ServiceName"] != nil
              - set(attributes["duration.ns"], Int(cache["Duration"])) where cache["Duration"] != nil

      batch:
        send_batch_size: 4096
        timeout: 5s

    exporters:
      otlphttp:
        endpoint: http://loki.monitoring.svc.cluster.local:3100/otlp
        headers:
          # Fixes the 401 Unauthenticated error
          X-Scope-OrgID: fake-org

      # Use 'debug' for modern collectors
      debug:
        verbosity: detailed

    service:
      pipelines:
        logs:
          receivers: [otlp]
          processors: [transform/traefik, batch]
          exporters: [otlphttp, debug]