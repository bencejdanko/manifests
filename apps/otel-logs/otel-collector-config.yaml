apiVersion: v1
kind: ConfigMap
metadata:
  name: otel-collector-config
  namespace: monitoring
data:
  collector.yaml: |
    receivers:
      otlp:
        protocols:
          http:  # listens on :4318 by default

    processors:
      # optional: parse Traefik JSON body and promote a few fields to attributes
      transform/traefik:
        error_mode: ignore
        log_statements:
          - context: log
            statements:
              - set(body, ParseJSON(body)) where IsString(body)
              - set(attributes["http.method"], body.RequestMethod) where IsMap(body)
              - set(attributes["http.target"], body.RequestPath) where IsMap(body)
              - set(attributes["http.status_code"], ToInt(body.DownstreamStatus)) where IsMap(body)
              - set(attributes["net.host.name"], body.RequestHost) where IsMap(body)
              - set(attributes["traefik.entrypoint"], body.entryPointName) where IsMap(body)
              - set(attributes["traefik.router"], body.RouterName) where IsMap(body)
              - set(attributes["traefik.service"], body.ServiceName) where IsMap(body)
              - set(attributes["duration.ns"], ToInt(body.Duration)) where IsMap(body)

      batch:
        send_batch_size: 4096
        timeout: 5s

    exporters:
      # >>> send to Loki's native OTLP endpoint (no custom labels block here)
      otlphttp:
        endpoint: http://loki.monitoring.svc.cluster.local:3100/otlp

    service:
      pipelines:
        logs:
          receivers: [otlp]
          processors: [transform/traefik, batch]
          exporters: [otlphttp]
