apiVersion: v1
kind: ConfigMap
metadata:
  name: promtail-config
  namespace: monitoring
data:
  promtail.yaml: |
    server:
      http_listen_port: 9080
      grpc_listen_port: 0

    clients:
      - url: http://loki.monitoring.svc.cluster.local:3100/loki/api/v1/push

    positions:
      filename: /run/promtail/positions.yaml

    scrape_configs:
      # Only scrape Traefik logs from kube-system
      - job_name: kubernetes-traefik-stdout
        pipeline_stages:
          - json:
              expressions:
                # Common Traefik JSON access log fields (v2):
                # different installs may name these slightly differently; we extract liberally.
                ts: time
                level: level
                msg: msg
                # request/response fields (may or may not exist depending on config)
                method: request_Method
                path: request_Path
                proto: request_Protocol
                host: request_Addr
                authority: request_Authority
                status: DownstreamStatus
                duration: request_Duration
                router: RouterName
                service: ServiceName
                entrypoint: EntryPoint
          # map a few low-cardinality labels (avoid labeling path/host/user-agent!)
          - labels:
              level:
              status:
              method:
              router:
              service:
              entrypoint:
          # optional: keep original line as `log` field; nothing else to do
        kubernetes_sd_configs:
          - role: pod
        relabel_configs:
          # Keep only pods in kube-system
          - source_labels: [__meta_kubernetes_namespace]
            regex: kube-system
            action: keep
          # Keep only traefik containers
          - source_labels: [__meta_kubernetes_pod_label_app_kubernetes_io_name]
            regex: traefik
            action: keep
          # Set job & app labels
          - target_label: job
            replacement: traefik
          - target_label: app
            replacement: traefik
          # Standard Kubernetes meta labels
          - action: replace
            source_labels: [__meta_kubernetes_namespace]
            target_label: namespace
          - action: replace
            source_labels: [__meta_kubernetes_pod_name]
            target_label: pod
          - action: replace
            source_labels: [__meta_kubernetes_pod_container_name]
            target_label: container

      # (Optional) Also scrape Traefik controller logs (non-access) if helpful:
      - job_name: kubernetes-traefik-controller
        kubernetes_sd_configs:
          - role: pod
        relabel_configs:
          - source_labels: [__meta_kubernetes_namespace]
            regex: kube-system
            action: keep
          - source_labels: [__meta_kubernetes_pod_label_app_kubernetes_io_name]
            regex: traefik
            action: keep
          - source_labels: [__meta_kubernetes_pod_container_name]
            regex: traefik
            action: keep
          - target_label: job
            replacement: traefik-controller
          - action: replace
            source_labels: [__meta_kubernetes_namespace]
            target_label: namespace
          - action: replace
            source_labels: [__meta_kubernetes_pod_name]
            target_label: pod
          - action: replace
            source_labels: [__meta_kubernetes_pod_container_name]
            target_label: container
